name: Build and push to Github packages [ghcr.io]

on:
  push:
    branches: [ "mariadb10.2.44" ]
  workflow_dispatch:

jobs:
  build_and_publish:
    name: Build and publish Docker image
    runs-on: ubuntu-latest
    continue-on-error: false
    env:
      GIT_BRANCH: mariadb10.2.44
      MARIADB_VERSION: 10.2.44
      DOCKER_IMAGE_NAME: florinbuzec/mysql-src-h
      DOCKER_IMAGE_TAG: mariadb-10.2.44

    steps:
      - name: Setup variables
        run: |
          echo "DOCKER_IMAGE_FULL=ghcr.io/$DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG" >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_BRANCH }}
          fetch-depth: 0
        
      # - name: Lint via Hadolint tool
      #   run: |
      #     docker run --rm -i hadolint/hadolint < Dockerfile

      # - name: Build Docker image
      #   run: |
      #     docker build . \
      #       --build-arg MARIADB_VERSION=${{ env.MARIADB_VERSION }} \
      #       -t ${{ env.DOCKER_IMAGE_FULL }} -f ./Dockerfile .

      # # https://github.com/settings/tokens/new?scopes=write:packages
      # - name: Registry login
      #   run: |
      #     if [ -z "$${{ secrets.GHCR_TOKEN }}" ]; then \
      #       echo "Please configure the repository secrets with required variables (GHCR_TOKEN,GHCR_USERNAME)."; \
      #       exit 1; \
      #     fi; \
      #     echo {{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u {{ secrets.GHCR_USERNAME }} --password-stdin

      # - name: Publish image
      #   run: |
      #     docker push ${{ env.DOCKER_IMAGE_FULL }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_FULL }}
